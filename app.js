// Minimal behavior restored as in v26 from previous step.
const tabbar=document.getElementById('tabs');const panels=[...document.querySelectorAll('.panel')];
function showPanel(id){panels.forEach(p=>p.classList.add('hidden'));document.getElementById(id).classList.remove('hidden');[...tabbar.querySelectorAll('button')].forEach(b=>b.classList.toggle('active',b.dataset.target===id));window.scrollTo({top:0,behavior:'smooth'})}
tabbar.addEventListener('click',e=>{const b=e.target.closest('button[data-target]');if(!b)return;showPanel(b.dataset.target)});showPanel('sinus');
const spTabs=document.getElementById('spTabs');if(spTabs){const spPanels=[...document.querySelectorAll('.subpanel')];function showSp(id){spPanels.forEach(p=>p.classList.add('hidden'));document.getElementById(id).classList.remove('hidden');[...spTabs.querySelectorAll('button')].forEach(b=>b.classList.toggle('active',b.dataset.target===id));window.scrollTo({top:0,behavior:'smooth'})}spTabs.addEventListener('click',e=>{const b=e.target.closest('button[data-target]');if(!b)return;showSp(b.dataset.target)});showSp('sp_valv')}
function v(x){if(x===null||x===undefined)return null;const s=String(x).replace(',','.');const n=Number(s);return Number.isFinite(n)?n:null}
function yes(sel){return(sel?.value||'')==='si'}function pill(l,c=''){return`<span class="pill ${c}">${l}</span>`}function headline(t){return`<div class="headline">${t}</div>`}function kv(k,vv){return`<div class="kv"><div class="k">${k}</div><div class="v">${vv}</div></div>`}function info(t){return` <span class="badge-ico" title="${t}">ⓘ</span>`}function copyBlock(t){return`<div class="copy"><button onclick="navigator.clipboard.writeText(\`${t.replace(/`/g,'\\`')}\`)">Copia risultato</button><span class="k">copiato negli appunti</span></div>`}
function setInlineMsg(el,text,type='warn'){if(!el)return;let m=el.parentElement.querySelector('.inline-msg');if(!m){m=document.createElement('div');m.className='inline-msg';el.parentElement.appendChild(m)}m.className='inline-msg '+(type==='err'?'err':'warn');m.textContent=text;el.classList.add('err-field')}
function clearInlineMsg(el){if(!el)return;const m=el.parentElement.querySelector('.inline-msg');if(m)m.remove();el.classList.remove('err-field')}
function eAvg(s,l){const a=[s,l].filter(x=>x!=null);if(!a.length)return null;return a.reduce((A,B)=>A+B,0)/a.length}function Ee_from(E,e){if(E==null||e==null||e<=0)return null;return E/e}function Ee_avg(E,s,l){const em=eAvg(s,l);return Ee_from(E,em)}
function ageThr(age){if(age==null)return{sept:6,lat:7,avg:6.5};if(age<40)return{sept:7,lat:10,avg:9};if(age<=65)return{sept:6,lat:8,avg:7};return{sept:6,lat:7,avg:6.5}}
function requireEAndEprime(Eel,eEls,l){let ok=true;if(v(Eel.value)==null&&eEls.some(e=>v(e.value)!=null)){setInlineMsg(Eel,`Inserisci E per calcolare ${l}.`,'warn');ok=false}else{clearInlineMsg(Eel)}if(v(Eel.value)!=null&&eEls.every(e=>v(e.value)==null)){const tgt=eEls[0];setInlineMsg(tgt,`Inserisci almeno un e′ (settale o laterale) per calcolare ${l}.`,'warn');ok=false}else{eEls.forEach(clearInlineMsg)}return ok}
function runSin(){const ageEl=document.getElementById('sin_age');const Eel=document.getElementById('sin_E');const eS=document.getElementById('sin_e_sept');const eL=document.getElementById('sin_e_lat');requireEAndEprime(Eel,[eS,eL],'E/e′');const age=v(ageEl.value);const eSept=v(eS.value);const eLat=v(eL.value);const E=v(Eel.value);const EA=v(document.getElementById('sin_EA').value);const TR=v(document.getElementById('sin_TR').value);const PASP=v(document.getElementById('sin_PASP').value);const lavi=v(document.getElementById('sin_lavi').value);const pv_sd=v(document.getElementById('sin_pv_sd').value);const lars=v(document.getElementById('sin_lars').value);const ivrt=v(document.getElementById('sin_ivrt').value);const ar_a=v(document.getElementById('sin_ar_a').value);const lwave=v(document.getElementById('sin_lwave').value);const pr_ed=v(document.getElementById('sin_pr_ed').value);const padp=v(document.getElementById('sin_padp').value);if(age==null){setInlineMsg(ageEl,'Inserisci l’età per applicare le soglie di e′.','err')}else{clearInlineMsg(ageEl)}const thr=ageThr(age);const eM=eAvg(eSept,eLat);const red_e=(eSept!=null&&eSept<thr.sept)||(eLat!=null&&eLat<thr.lat)||(eM!=null&&eM<thr.avg);const Ee_m=Ee_avg(E,eSept,eLat);const Ee_s=Ee_from(E,eSept);const Ee_l=Ee_from(E,eLat);const highEe=(Ee_m!=null&&Ee_m>14)||(Ee_s!=null&&Ee_s>15)||(Ee_l!=null&&Ee_l>13);const trpasp=(PASP!=null?PASP>=35:(TR!=null&&TR>=2.8));const baseCount=[red_e,highEe,trpasp].filter(Boolean).length;const suppAbn=(pv_sd!=null&&pv_sd<=0.67)||(lars!=null&&lars<=18)||(lavi!=null&&lavi>34)||(ivrt!=null&&ivrt<=70)||(ar_a!=null&&ar_a>30)||(lwave!=null&&lwave>=50)||(pr_ed!=null&&pr_ed>=2.0)||(padp!=null&&padp>=16);let lap='Indeterminate',status='warn';if(baseCount===3){lap='Aumentate';status='bad'}else if(baseCount===0){lap='Normali';status='good'}else{lap=suppAbn?'Aumentate':'Indeterminate';status=suppAbn?'bad':'warn'}let grade=null;if(EA!=null){if(EA>=2){grade='Grado III'}else if(EA<=0.8){grade=(E!=null&&E<=50&&lap!=='Aumentate')?'Grado I':(lap==='Aumentate'?'Grado II':'Grado I')}else{grade=(lap==='Aumentate')?'Grado II':'Grado I'}}let phrase='';if(lap==='Normali'&&(!grade||grade==='Grado I'))phrase='**Disturbo di rilasciamento (grado I) o pattern nei limiti**, con pressioni di riempimento nei limiti.';else if(grade==='Grado II')phrase='**Pattern pseudonormalizzato (grado II)**, con aumento delle pressioni di riempimento del ventricolo sinistro.';else if(grade==='Grado III')phrase='**Pattern restrittivo (grado III)**, con marcato aumento delle pressioni di riempimento del ventricolo sinistro.';else if(lap==='Aumentate')phrase='**LAP aumentate** con pattern non pienamente classificabile (integrare con variabili di supporto).';else phrase='**Valutazione indeterminata**: integrare con variabili di supporto o eco diastolica da sforzo.';const out=document.getElementById('sin_result');let pills=pill(`LAP: ${lap}`,status==='bad'?'bad':(status==='good'?'good':'warn'))+(grade?pill(grade,grade==='Grado III'?'bad':(grade==='Grado II'?'warn':'good')):'');let details=kv("e′ media (calcolata)",(eM!=null?eM.toFixed(1)+' cm/s':'—')+info("e′ media = media(e′ settale, e′ laterale)"));details+=kv("E/e′ media (calcolata)",(Ee_m!=null?Ee_m.toFixed(1):'—')+info("E/e′ media = E / e′ media"));details+=kv("E/e′ settale (calcolata)",(Ee_s!=null?Ee_s.toFixed(1):'—')+info("E/e′ settale = E / e′ settale"));details+=kv("E/e′ laterale (calcolata)",(Ee_l!=null?Ee_l.toFixed(1):'—')+info("E/e′ laterale = E / e′ laterale"));details+=kv("Variabili base patologiche",`${baseCount}/3`);if(suppAbn)details+=kv("Supporto positivo","Presente");const txtCopy=`Ritmo sinusale — LAP ${lap}${grade?" — "+grade:""}. ${phrase.replace(/\*\*/g,'')}`;out.innerHTML=`<div class="pills">${pills}</div>${headline(phrase)}${details}${copyBlock(txtCopy)}`}
document.getElementById('sin_calc').addEventListener('click',runSin);
function noop(){}
document.getElementById('af_calc').addEventListener('click',noop);
document.getElementById('valv_calc').addEventListener('click',noop);
document.getElementById('htx_calc').addEventListener('click',noop);
document.getElementById('ph_calc').addEventListener('click',noop);
document.getElementById('av_calc').addEventListener('click',noop);
document.getElementById('rcm_calc').addEventListener('click',noop);
document.getElementById('cp_calc').addEventListener('click',noop);
document.getElementById('hcm_calc').addEventListener('click',noop);
document.querySelectorAll('[data-reset]').forEach(btn=>{btn.addEventListener('click',()=>{const id=btn.dataset.reset;if(id==='special_all'){document.querySelectorAll('#special .subpanel input, #special .subpanel select').forEach(i=>{if(i.tagName==='SELECT')i.selectedIndex=0;else i.value='';});document.querySelectorAll('#special .result').forEach(r=>r.innerHTML='');return}const panel=document.getElementById(id);panel.querySelectorAll('input').forEach(i=>{if(i.type==='checkbox')i.checked=false;else i.value='' });panel.querySelectorAll('select').forEach(s=>s.selectedIndex=0);const res=panel.querySelector('.result');if(res)res.innerHTML='';});});